---
output: html_document
---

```{r echo = F}
knitr::opts_chunk$set(echo = T, warning = F)
options(dplyr.width = Inf)
```

# Estimates of flow-weighted mean concentrations

Load libraries and import data:
```{r, message = F, warning = F}
library(tidyverse)
library(readxl)
library(lubridate)

# metal data
dat <- read.csv('data/raw/Trace_Metals_Apr2019.csv', stringsAsFactors = F)

# watershed area data
wshed <- read_excel('data/raw/SDRS Revised StationID Table.xlsx', skip = 2)
```

Format watershed data:

* select only watershed name and area
* rename columns
* remove numbers from site, correct USJ to USJC to match metal sites
```{r}
wshed <- wshed %>% 
  select(`Station Code`, Area) %>% 
  na.omit %>% 
  rename(
    SITE = `Station Code`, 
    AREAKM2 = Area
  ) %>% 
  mutate(
    SITE = gsub('[0-9]*$', '', SITE),
    SITE = ifelse(SITE == 'USJ', 'USJC', SITE)
  )
```

Format metal data:

* remove unnecessary columns
* separete site and storm numbers into two columns
* format date time by combining date and time
* join wshed area to data
* put in long format by consituent
* remove "DF" (dissolved fraction) variables
* concentration value as numeric
* add units column

```{r}
dat <- dat %>%
  select(-SIZE, -GEO) %>% 
  unite('DATETIME', DATE, TIME) %>% 
  mutate(
    STRM = gsub('^[a-z,A-Z]*', '', SITE),
    STRM = ifelse(STRM == '', 'x', STRM),
    SITE = gsub('[0-9]*$', '', SITE),
    DATETIME = mdy_hm(DATETIME, tz = 'Etc/GMT+8'),
    YR = year(DATETIME)
  ) %>% 
  left_join(wshed, by = 'SITE') %>% 
  gather('VAR', 'VAL', -SITE, -STRM, -DATETIME, -YR, -TYPE, -SEASON, -FLOWCMS, -AREAKM2) %>% 
  filter(!grepl('^DF', VAR)) %>% 
  mutate(
    VAL = as.numeric(VAL),
    UNIT = case_when(
      VAR %in% c('Cl', 'Hard', 'S04', 'TDS', 'TotAlk', 'TSS') ~ 'mg/L', 
      T ~ 'ug/L'
    )
  ) 
```

Group the metals data by aggregations to calculate:
```{r}
datgrp <- dat %>% 
  group_by(SITE, STRM, UNIT, AREAKM2, SEASON, YR, TYPE, VAR) %>% 
  nest
datgrp
```

A function that estimates flow-weighted mean concentrations:
```{r}
emc_fun <- function(x){

  # get supporting data for calcs
  x <- x %>% 
    na.omit %>% 
    mutate(
      litersmin = FLOWCMS * 60 * 1000, 
      elapsed_min = c(1, difftime(DATETIME[-1], DATETIME[-nrow(.)], units = 'mins')),
      liters = litersmin * elapsed_min,
      litersresult = liters * VAL # either mg or ug depending on constituent
    )

  # mass emissions, elapsed days, emc
  massemis <- cumsum(x$litersresult) %>% max
  dys <- difftime(max(x$DATETIME), min(x$DATETIME), units = 'days') %>% as.numeric
  emc <- massemis / sum(x$liters)

  out <- data.frame(massemis = massemis, dys = dys, emc = emc)
  
  return(out)
  
}
```

Apply the function to each value in `data`:
```{r}
datgrp <- datgrp %>% 
  mutate(
    emc = map(data, emc_fun)
  )
datgrp
```

Expand dataset into results;
```{r}
datgrp <- datgrp %>% 
  select(-data) %>% 
  unnest
datgrp
```

Estimate mass loadings as kg/day:
```{r}
datgrp <- datgrp %>% 
  mutate(
    massload = case_when(
      UNIT %in% 'mg/L' ~ massemis * 1e-6 / dys, 
      UNIT %in% 'ug/L' ~ massemis * 1e-9 / dys
    )
  )
datgrp
```
